<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ligg.mapper.ProjectMapper">

    <select id="projectCount" resultType="java.lang.Integer">
        select count(*) from phone_project where project_name = #{projectName}
    </select>

    <!-- 查询项目列表 -->
    <select id="getAllProjectsList" resultType="com.ligg.common.dto.ProjectListDto">
        SELECT 
            project_id AS projectId,
            project_name AS projectName,
            project_price AS projectPrice,
            phone_count AS phoneCount
        FROM 
            view_project_phone_count
        ORDER BY 
            phone_count DESC
    </select>


    <!-- 根据项目名称查询手机号列表 -->
    <select id="getPhonesByProject" resultType="com.ligg.common.entity.PhoneEntity">
        SELECT p.*
        FROM phone p
        JOIN phone_project_relation ppr ON p.phone_id = ppr.phone_id
        JOIN project pj ON ppr.project_id = pj.project_id
        WHERE p.usage_status = 1 
        AND p.line_status = 1
        <if test="projectNames != null and projectNames.length > 0">
            AND pj.project_name IN
            <foreach collection="projectNames" item="name" open="(" separator="," close=")">
                #{name}
            </foreach>
        </if>
    </select>

    <!--获取项目所有地区和每个地区的手机号数量-->
    <select id="getProjectCommodityList" resultType="com.ligg.common.dto.RegionCommodityDto">
        SELECT 
            r.region_id as regionId,
            r.region_name as regionName,
            r.region_mark as regionMark,
            pj.project_price as projectPrice,
            COUNT(p.phone_id) as phoneCount
        FROM 
            project pj
        LEFT JOIN phone_project_relation ppr ON pj.project_id = ppr.project_id
        LEFT JOIN phone p ON ppr.phone_id = p.phone_id AND p.usage_status = 1 AND p.line_status = 1
        LEFT JOIN region r ON p.region_id = r.region_id
        WHERE
            pj.project_id = #{projectId}
        GROUP BY 
            r.region_id, r.region_name, r.region_mark, pj.project_price
        ORDER BY 
            phoneCount DESC
    </select>

    <!--获取所有项目数据-->
    <select id="getProject" resultType="com.ligg.common.entity.ProjectEntity">
        select project_id,project_name,project_price,project_created_at
        from project
    </select>

    <!--获取所有地区-->
    <select id="getRegion" resultType="com.ligg.common.entity.RegionEntity">
        select region_id,region_name,region_mark
        from region
    </select>
    
    <!--根据项目名称查询项目ID-->
    <select id="getProjectIdByName" resultType="java.lang.Integer">
        SELECT project_id
        FROM project
        WHERE project_name = #{projectName}
        LIMIT 1
    </select>
    
    <!--批量根据项目名称查询项目ID列表-->
    <select id="getProjectIdsByNames" resultType="java.lang.Integer">
        SELECT project_id
        FROM project
        WHERE project_name IN
        <foreach collection="projectNames" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
    </select>
</mapper>