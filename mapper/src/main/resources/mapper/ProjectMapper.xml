<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ligg.mapper.ProjectMapper">

    <select id="projectCount" resultType="java.lang.Integer">
        select count(*) from phone_project where project_name = #{projectName}
    </select>

    <!-- 查询项目列表 -->
    <select id="getAllProjectsList" resultType="com.ligg.common.dto.ProjectListDto">
        SELECT 
            p.project_id AS projectId,
            p.project_name AS projectName,
            p.project_price AS projectPrice,
            COUNT(ph.phone_id) AS phoneCount
        FROM 
            project p
        LEFT JOIN 
            phone_project_relation ppr ON p.project_id = ppr.project_id
        LEFT JOIN phone ph ON ppr.phone_number = ph.phone_number
        GROUP BY
            p.project_id, p.project_name, p.project_price
        ORDER BY 
            phoneCount DESC
    </select>


    <!-- 根据项目名称查询手机号列表 -->
    <select id="getPhonesByProject" resultType="com.ligg.common.entity.PhoneEntity">
        SELECT *
        FROM phone
        WHERE usage_status = 1 
        AND line_status = 1
        <if test="projectNames != null and projectNames.length > 0">
            AND project_name IN
            <foreach collection="projectNames" item="name" open="(" separator="," close=")">
                #{name}
            </foreach>
        </if>
    </select>

    <!--获取项目所有地区和每个地区的手机号数量-->
    <select id="getProjectCommodityList" resultType="com.ligg.common.dto.RegionCommodityDto">
        SELECT 
            r.region_id as regionId,
            r.region_name as regionName,
            r.region_mark as regionMark,
            pj.project_price as projectPrice,
            COUNT(ppr.phone_number) as phoneCount
        FROM 
            project pj
        LEFT JOIN phone_project_relation ppr ON pj.project_id = ppr.project_id
        LEFT JOIN phone p ON ppr.phone_number = p.phone_number
        LEFT JOIN region r ON p.phone_region_id =r.region_id
        WHERE
            pj.project_id = #{projectId}
        GROUP BY 
            r.region_id, r.region_name, r.region_mark, pj.project_price
        ORDER BY 
            phoneCount DESC
    </select>

    <!--获取所有项目数据-->
    <select id="getProject" resultType="com.ligg.common.entity.ProjectEntity">
        select project_id,project_name,project_price,project_created_at
        from project
    </select>

    <!--获取所有地区-->
    <select id="getRegion" resultType="com.ligg.common.entity.RegionEntity">
        select region_id,region_name,region_mark
        from region
    </select>
    
    <!--根据项目名称查询项目ID-->
    <select id="getProjectIdByName" resultType="java.lang.Integer">
        SELECT project_id
        FROM project
        WHERE project_name = #{projectName}
        LIMIT 1
    </select>
    
    <!--批量根据项目名称查询项目ID列表-->
    <select id="getProjectIdsByNames" resultType="java.lang.Integer">
        SELECT project_id
        FROM project
        WHERE project_name IN
        <foreach collection="projectNames" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
    </select>
</mapper>