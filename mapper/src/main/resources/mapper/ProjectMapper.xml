<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ligg.mapper.ProjectMapper">

    <!-- 查询项目列表 -->
    <select id="getAllProjectsList" resultType="com.ligg.common.dto.ProjectListDto">
        SELECT p.project_id,
               p.project_name,
               p.project_price,
               p.icon,
               count(ppr.phone_id) AS phoneCount
        FROM project p
                 left join phone_project_relation ppr on p.project_id = ppr.project_id
        GROUP BY p.project_id, p.project_name, p.project_price
        ORDER BY phoneCount DESC
    </select>


    <!-- 根据项目名称查询手机号列表 -->
    <select id="getPhonesByProject" resultType="com.ligg.common.entity.PhoneEntity">
        SELECT p.*
        FROM phone p
        JOIN phone_project_relation ppr ON p.phone_id = ppr.phone_id
        JOIN project pj ON ppr.project_id = pj.project_id
        WHERE p.usage_status = 1
        AND p.line_status = 1
        <if test="projectNames != null and projectNames.length > 0">
            AND pj.project_name IN
            <foreach collection="projectNames" item="name" open="(" separator="," close=")">
                #{name}
            </foreach>
        </if>
    </select>

    <!--获取项目所有地区和每个地区的手机号数量-->
    <select id="getProjectCommodityList" resultType="com.ligg.common.dto.RegionCommodityDto">
        SELECT r.region_id,
               r.region_name,
               r.region_mark,
               r.icon,
               COUNT(ppr.phone_id) as phoneCount
        FROM phone_project_relation ppr
                 left join region r on ppr.region_id = r.region_id
        WHERE ppr.project_id = #{projectId}
          AND ppr.is_available = 0
        GROUP BY r.region_id, r.region_name, r.region_mark
        ORDER BY phoneCount DESC
    </select>

    <!--获取所有项目数据-->
    <select id="getProject" resultType="com.ligg.common.entity.ProjectEntity">
        select project_id, project_name, project_price, project_created_at
        from project
    </select>

    <!--获取所有地区-->
    <select id="getRegion" resultType="com.ligg.common.entity.RegionEntity">
        select region_id, region_name, region_mark
        from region
    </select>

    <!--根据项目名称查询项目ID-->
    <select id="getProjectIdByName" resultType="java.lang.Integer">
        SELECT project_id
        FROM project
        WHERE project_name = #{projectName}
        LIMIT 1
    </select>

    <!--批量根据项目名称查询项目ID列表-->
    <select id="getProjectIdsByNames" resultType="java.lang.Integer">
        SELECT project_id
        FROM project
        WHERE project_name IN
        <foreach collection="projectNames" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
    </select>

    <!--根据项目名称查询项目id-->
    <select id="selectByProjectName" resultType="com.ligg.common.entity.ProjectEntity">
        select project_id
        from project
        where project_name = #{projectName}
    </select>
</mapper>