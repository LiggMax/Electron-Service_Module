<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ligg.mapper.PhoneNumberMapper">

    <!-- 批量插入手机号 -->
    <insert id="batchInsertPhones">
        INSERT INTO phone
        (phone_number, registration_time, usage_status, admin_user_id, money)
        values
        <foreach collection="list" item="phone" separator=",">
            (
            #{phone.phoneNumber},
            #{phone.registrationTime},
            #{phone.usageStatus},
            #{phone.adminUserId},
            #{phone.money}
            )
        </foreach>
    </insert>

    <!-- 查询手机号是否存在 -->
    <select id="getPhoneByNumber" resultType="com.ligg.common.entity.PhoneEntity">
        SELECT * FROM phone WHERE phone_number = #{phoneNumber}
    </select>
    
    <!-- 检查手机号是否存在 -->
    <select id="checkPhoneExists" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM phone WHERE phone_number = #{phoneNumber}
    </select>

    <!-- 插入手机号和项目关联信息到 phone_project_relation 表 -->
    <insert id="insertPhoneProject">
        INSERT INTO phone_project_relation(phone_id, project_id, region_id, is_available, created_at)
        SELECT p.phone_id, #{projectId}, #{regionId}, 0, NOW()
        FROM phone p 
        WHERE p.phone_number = #{phoneNumber}
    </insert>

    <!-- 删除手机号 -->
    <delete id="deletePhone">
        delete from phone
        where phone_id = #{phoneId}
    </delete>

    <!--卡商获取手机号列表 -->
    <select id="phoneList" resultType="com.ligg.common.vo.PhoneVo">
        SELECT 
            p.phone_id, 
            p.phone_number, 
            p.registration_time, 
            p.money,
            r.region_name,
            GROUP_CONCAT(DISTINCT pj.project_name SEPARATOR ', ') as projectName
        FROM phone p
        JOIN phone_project_relation ppr ON p.phone_id = ppr.phone_id
        JOIN region r ON ppr.region_id = r.region_id
        LEFT JOIN admin_users au ON p.admin_user_id = au.user_id
        LEFT JOIN project pj ON ppr.project_id = pj.project_id
        <where>
            <if test="countryCode != null and countryCode != '' ">
                r.region_name like concat('%', #{countryCode}, '%')
            </if>
            <if test="keyword != null and keyword != ''">
                and (p.phone_number like concat('%', #{keyword}, '%')
                or r.region_name like concat('%', #{keyword}, '%')
                or p.usage_status like concat('%', #{keyword}, '%'))
            </if>
            and p.admin_user_id = #{adminUserId}
        </where>
        GROUP BY p.phone_id, p.phone_number, p.registration_time, p.money, r.region_name
        ORDER BY p.phone_id DESC
    </select>

    <!-- 根据手机号ID查询手机详情 -->
    <select id="queryByIdPhoneDetail" resultType="com.ligg.common.dto.PhoneDetailDto">
        SELECT
            p.phone_id,
            p.phone_number,
            r.region_name as countryCode,
            p.usage_status,
            p.registration_time,
            pj.project_name,
            uo.created_at as time_of_use
        FROM phone p
        LEFT JOIN region r ON p.region_id = r.region_id
        LEFT JOIN user_order uo ON p.phone_number = uo.phone_number
        LEFT JOIN project pj ON uo.project_id = pj.project_id
        WHERE p.phone_id = #{phoneId}
    </select>
    
    <select id="getPhonesByProject" resultType="com.ligg.common.entity.PhoneEntity">
        select p.phone_id, p.phone_number,p.admin_user_id
        from phone_project_relation ppr
        left join phone p on ppr.phone_id = p.phone_id
        where ppr.region_id = #{regionId}
        limit 100
    </select>

    <select id="getPhoneDetail" resultType="com.ligg.common.dto.PhoneDetailDto">
        select *
        from phone
        where phone_id = #{phoneId}
    </select>


    <!-- 使用PhoneAndProjectDto的嵌套结果映射 -->
    <resultMap id="PhoneAndProjectDtoMap" type="com.ligg.common.dto.PhoneAndProjectDto">
        <!-- 基本信息部分 -->
        <id property="phoneId" column="phone_id"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="usageStatus" column="usage_status"/>
        <result property="registrationTime" column="registration_time"/>
        <result property="countryCode" column="country_code"/>
        <result property="regionName" column="region_name"/>
        
        <!-- 项目信息集合，使用collection标签 -->
        <collection property="projects" ofType="com.ligg.common.entity.ProjectEntity" 
                    column="phone_id" select="getPhoneProject"/>
    </resultMap>
    
    <!-- 获取手机号和关联项目信息（使用DTO对象） -->
    <select id="getPhoneAndProject" resultMap="PhoneAndProjectDtoMap">
        SELECT 
            p.phone_id,
            p.phone_number,
            p.usage_status,
            p.registration_time,
            r.region_name
        FROM phone p
        LEFT JOIN region r ON p.region_id = r.region_id
        WHERE p.phone_id = #{phoneId} and p.admin_user_id = #{adminUserId}
    </select>

    <!-- 根据手机号查询关联的项目 -->
    <select id="getProjectByPhoneNumber" resultType="com.ligg.common.entity.ProjectEntity">
        SELECT 
            p.project_id,
            p.project_name,
            p.project_price
        FROM phone_project_relation ppr
        JOIN phone ph ON ppr.phone_id = ph.phone_id
        LEFT JOIN project p ON ppr.project_id = p.project_id
        WHERE ph.phone_number = #{phoneNumber}
    </select>
    
    <!-- 根据地区ID获取可用的手机号 -->
    <select id="getAvailablePhonesByRegion" resultType="com.ligg.common.entity.PhoneEntity">
        SELECT *
        FROM phone
        WHERE region_id = #{regionId}
        AND usage_status = 1
        LIMIT 100
    </select>

    <!-- 获取号码列表 -->
    <select id="getPhoneList" resultType="com.ligg.common.vo.PhoneVo">
        select p.phone_id,
               p.phone_number,
               p.usage_status,
               p.registration_time,
               p.money,
               r.region_name,
               GROUP_CONCAT(DISTINCT pj.project_name) as project_name,
               au.nick_name as admin_nick_name,
               au.user_avatar as admin_avatar
        from phone p
                  join region r on p.region_id = r.region_id
                  join admin_users au on p.admin_user_id = au.user_id
                  join phone_project_relation ppr on p.phone_id = ppr.phone_id
                  join project pj on ppr.project_id = pj.project_id
        group by p.phone_id, p.phone_number, p.usage_status, p.registration_time,
                 p.money, r.region_name, au.nick_name, au.user_avatar
    </select>

    <!-- 更新手机号状态 -->
    <update id="updatePhoneStatus">
        UPDATE phone
        SET usage_status = #{status}
        WHERE phone_id = #{phoneId}
    </update>

    <!-- 删除手机号与项目的关联关系 -->
    <delete id="deletePhoneProjectRelation">
        DELETE FROM phone_project_relation
        WHERE phone_id = #{phoneId} AND project_id = #{projectId}
    </delete>
</mapper>