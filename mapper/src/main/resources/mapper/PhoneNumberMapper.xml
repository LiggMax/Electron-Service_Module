<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ligg.mapper.PhoneNumberMapper">

    <!-- 批量插入手机号 -->
    <insert id="batchInsertPhones">
        INSERT INTO phone
        (phone_number, line_status, registration_time, usage_status, phone_region_id, phone_project_id,admin_user_id)
        values
        <foreach collection="list" item="phone" separator=",">
            (
            #{phone.phoneNumber},
            #{phone.lineStatus},
            #{phone.registrationTime},
            #{phone.usageStatus},
            #{phone.phoneRegionId},
            #{phone.phoneProjectId},
            #{phone.adminUserId}
            )
        </foreach>
    </insert>

    <!-- 查询手机号是否存在 -->
    <select id="getPhoneByNumber" resultType="com.ligg.common.entity.PhoneEntity">
        SELECT * FROM phone WHERE phone_number = #{phoneNumber}
    </select>
    
    <!-- 检查手机号是否存在 -->
    <select id="checkPhoneExists" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM phone WHERE phone_number = #{phoneNumber}
    </select>

    <!-- 插入手机号和项目关联信息到用户订单表 -->
    <insert id="insertPhoneProject">
        INSERT INTO user_order(user_id, phone_number, created_at, project_id)
        VALUES (1, #{phoneNumber}, NOW(), #{projectId})
    </insert>

    <!-- 删除手机号 -->
    <delete id="deletePhone">
        delete from phone
        where phone_id = #{phoneId}
    </delete>


    <select id="phoneList" resultType="com.ligg.common.entity.PhoneEntity">
        select p.*, r.region_name as countryCode
        from phone p
        left join region r on p.phone_region_id = r.region_id
        <where>
            <if test="countryCode != null and countryCode != '' ">
                r.region_name like concat('%', #{countryCode}, '%')
            </if>
            <if test="usageStatus != null">
                and p.usage_status = #{usageStatus}
            </if>
            <if test="keyword != null and keyword != ''">
                and (p.phone_number like concat('%', #{keyword}, '%')
                or r.region_name like concat('%', #{keyword}, '%')
                or p.usage_status like concat('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 根据手机号ID查询手机详情 -->
    <select id="queryByIdPhoneDetail" resultType="com.ligg.common.dto.PhoneDetailDto">
        SELECT
            p.phone_id,
            p.phone_number,
            r.region_name as countryCode,
            p.line_status,
            p.usage_status,
            p.registration_time,
            pj.project_name,
            uo.created_at as time_of_use
        FROM phone p
        LEFT JOIN region r ON p.phone_region_id = r.region_id
        LEFT JOIN user_order uo ON p.phone_number = uo.phone_number
        LEFT JOIN project pj ON uo.project_id = pj.project_id
        WHERE p.phone_id = #{phoneId}
    </select>
    
    <select id="getPhonesByProject" resultType="com.ligg.common.entity.PhoneEntity">
        select phone_id, phone_number, phone_project_id
        from phone
        where phone_region_id = #{regionId}
    </select>

    <select id="getPhoneDetail" resultType="com.ligg.common.dto.PhoneDetailDto">
        select *
        from phone
        where phone_id = #{phoneId}
    </select>


    <!-- 使用PhoneAndProjectDto的嵌套结果映射 -->
    <resultMap id="PhoneAndProjectDtoMap" type="com.ligg.common.dto.PhoneAndProjectDto">
        <!-- 基本信息部分 -->
        <id property="phoneId" column="phone_id"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="lineStatus" column="line_status"/>
        <result property="usageStatus" column="usage_status"/>
        <result property="registrationTime" column="registration_time"/>
        <result property="countryCode" column="country_code"/>
        <result property="regionName" column="region_name"/>
        
        <!-- 项目信息集合，使用collection标签 -->
        <collection property="projects" ofType="com.ligg.common.entity.ProjectEntity" 
                    column="phone_id" select="getPhoneProject"/>
    </resultMap>
    
    <!-- 获取手机号和关联项目信息（使用DTO对象） -->
    <select id="getPhoneAndProject" resultMap="PhoneAndProjectDtoMap">
        SELECT 
            p.phone_id,
            p.phone_number,
            p.line_status,
            p.usage_status,
            p.registration_time,
            r.region_name
        FROM phone p
        LEFT JOIN region r ON p.phone_region_id = r.region_id
        WHERE p.phone_id = #{phoneId} and p.admin_user_id = #{adminUserId}
    </select>

    <!-- 根据手机号查询关联的项目 -->
    <select id="getProjectByPhoneNumber" resultType="com.ligg.common.entity.ProjectEntity">
        SELECT 
            p.project_id,
            p.project_name,
            p.project_price
        FROM phone_project_relation ppr
        LEFT JOIN project p ON ppr.project_id = p.project_id
        WHERE ppr.phone_number = #{phoneNumber}
    </select>
</mapper>